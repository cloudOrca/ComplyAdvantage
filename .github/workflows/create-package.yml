name: Salesforce Package Deployment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Salesforce CLI
        run: |
          wget https://developer.salesforce.com/media/salesforce-cli/sfdx-linux-amd64.tar.xz
          mkdir ~/sfdx
          tar xJf sfdx-linux-amd64.tar.xz -C ~/sfdx --strip-components 1
          echo "$HOME/sfdx/bin" >> $GITHUB_PATH
          sfdx --version

      - name: Authenticate with Salesforce
        env:
          SF_AUTH_URL: ${{ secrets.SF_AUTH_URL }}
        run: |
          echo $SF_AUTH_URL > ./authfile.txt
          sfdx auth:sfdxurl:store -f ./authfile.txt -a DevHub -s

      - name: Create Package Version
        run: |
          sfdx force:package:version:create --package MyPackage --installationkey "" --wait 10 --targetdevhubusername DevHub

      - name: Install Package
        run: |
          sfdx force:package:install --package MyPackage --wait 10 --publishwait 10 --targetdevhubusername DevHub
